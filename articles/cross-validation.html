<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cross-Validation • chronofeat</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Inter-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cross-Validation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chronofeat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Core Concepts</h6></li>
    <li><a class="dropdown-item" href="../articles/custom-models.html">Building Custom Models</a></li>
    <li><a class="dropdown-item" href="../articles/feature-engineering.html">Feature Engineering Reference</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing.html">Data Preprocessing</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Evaluation &amp; Production</h6></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-Validation</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-workflows.html">Advanced Workflows</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/taf-society/chronofeat" aria-label="GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Cross-Validation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/taf-society/chronofeat/blob/main/vignettes/articles/cross-validation.Rmd" class="external-link"><code>vignettes/articles/cross-validation.Rmd</code></a></small>
      <div class="d-none name"><code>cross-validation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Time series cross-validation is essential for:</p>
<ul>
<li>
<strong>Evaluating</strong> model performance realistically</li>
<li>
<strong>Comparing</strong> different models or feature sets</li>
<li>
<strong>Tuning</strong> hyperparameters</li>
<li>
<strong>Estimating</strong> forecast uncertainty</li>
</ul>
<p>Standard k-fold CV doesn’t work for time series because it violates
temporal ordering. chronofeat provides <code><a href="../reference/cv_forecast.html">cv_forecast()</a></code> for
proper time series cross-validation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://taf-society.github.io/chronofeat/">chronofeat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">retail</span><span class="op">)</span></span>
<span><span class="va">ts_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TimeSeries.html">TimeSeries</a></span><span class="op">(</span><span class="va">retail</span>, date <span class="op">=</span> <span class="st">"date"</span>, groups <span class="op">=</span> <span class="st">"items"</span>, frequency <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic Usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cv_results</span><span class="op">)</span></span>
<span><span class="co">#&gt; Time Series Cross-Validation Results</span></span>
<span><span class="co">#&gt; =====================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt;   Horizon (h): 6</span></span>
<span><span class="co">#&gt;   Number of windows: 5</span></span>
<span><span class="co">#&gt;   Completed folds: 5</span></span>
<span><span class="co">#&gt;   Window type: expanding</span></span>
<span><span class="co">#&gt;   Step size: 6</span></span>
<span><span class="co">#&gt;   Metric: rmse</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metrics by fold:</span></span>
<span><span class="co">#&gt;  fold train_start  train_end test_start   test_end n_train n_test     rmse</span></span>
<span><span class="co">#&gt;     1  1982-04-01 2007-06-01 2007-07-01 2007-12-01   12726    252 44.98922</span></span>
<span><span class="co">#&gt;     2  1982-04-01 2007-12-01 2008-01-01 2008-06-01   12978    252 43.20317</span></span>
<span><span class="co">#&gt;     3  1982-04-01 2008-06-01 2008-07-01 2008-12-01   13230    252 64.45866</span></span>
<span><span class="co">#&gt;     4  1982-04-01 2008-12-01 2009-01-01 2009-06-01   13482    252 54.92877</span></span>
<span><span class="co">#&gt;     5  1982-04-01 2009-06-01 2009-07-01 2009-12-01   13734    252 62.57279</span></span>
<span><span class="co">#&gt;     0        &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;      NA   1260 54.73205</span></span></code></pre></div>
<div class="section level3">
<h3 id="understanding-the-output">Understanding the Output<a class="anchor" aria-label="anchor" href="#understanding-the-output"></a>
</h3>
<p>The output contains:</p>
<ul>
<li>
<strong>metrics</strong>: Per-fold and overall performance
metrics</li>
<li>
<strong>params</strong>: CV configuration parameters</li>
<li>
<strong>predictions</strong> (optional): Individual predictions for
analysis</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_results</span><span class="op">$</span><span class="va">metrics</span></span>
<span><span class="co">#&gt;   fold train_start  train_end test_start   test_end n_train n_test     rmse</span></span>
<span><span class="co">#&gt; 1    1  1982-04-01 2007-06-01 2007-07-01 2007-12-01   12726    252 44.98922</span></span>
<span><span class="co">#&gt; 2    2  1982-04-01 2007-12-01 2008-01-01 2008-06-01   12978    252 43.20317</span></span>
<span><span class="co">#&gt; 3    3  1982-04-01 2008-06-01 2008-07-01 2008-12-01   13230    252 64.45866</span></span>
<span><span class="co">#&gt; 4    4  1982-04-01 2008-12-01 2009-01-01 2009-06-01   13482    252 54.92877</span></span>
<span><span class="co">#&gt; 5    5  1982-04-01 2009-06-01 2009-07-01 2009-12-01   13734    252 62.57279</span></span>
<span><span class="co">#&gt; 6    0        &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;      NA   1260 54.73205</span></span></code></pre></div>
<ul>
<li>
<code>fold = 0</code> is the overall (weighted average) metric</li>
<li>Each fold shows training and test date ranges</li>
<li>
<code>n_train</code> and <code>n_test</code> show observation
counts</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="window-types">Window Types<a class="anchor" aria-label="anchor" href="#window-types"></a>
</h2>
<div class="section level3">
<h3 id="expanding-window-default">Expanding Window (Default)<a class="anchor" aria-label="anchor" href="#expanding-window-default"></a>
</h3>
<p>The training set grows with each fold:</p>
<pre><code>Fold 1: [----Train----][Test]
Fold 2: [------Train------][Test]
Fold 3: [--------Train--------][Test]</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_expanding</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  window_type <span class="op">=</span> <span class="st">"expanding"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Best for:</strong> Most cases. More training data improves
model estimates.</p>
</div>
<div class="section level3">
<h3 id="sliding-window">Sliding Window<a class="anchor" aria-label="anchor" href="#sliding-window"></a>
</h3>
<p>Fixed-size training window that slides forward:</p>
<pre><code>Fold 1: [----Train----][Test]
Fold 2:    [----Train----][Test]
Fold 3:       [----Train----][Test]</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_sliding</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  window_type <span class="op">=</span> <span class="st">"sliding"</span>,</span>
<span>  window_size <span class="op">=</span> <span class="fl">120</span>  <span class="co"># Use last 120 observations for training</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Best for:</strong></p>
<ul>
<li>Non-stationary data where old patterns don’t apply</li>
<li>Models that should only use recent data</li>
<li>Testing how model performs with limited history</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="configuring-cv">Configuring CV<a class="anchor" aria-label="anchor" href="#configuring-cv"></a>
</h2>
<div class="section level3">
<h3 id="horizon-h">Horizon (<code>h</code>)<a class="anchor" aria-label="anchor" href="#horizon-h"></a>
</h3>
<p>Forecast horizon - how many steps ahead to predict:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Match your production forecast horizon</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">...</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">12</span>  <span class="co"># If you forecast 12 months ahead in production</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="number-of-windows-n_windows">Number of Windows (<code>n_windows</code>)<a class="anchor" aria-label="anchor" href="#number-of-windows-n_windows"></a>
</h3>
<p>More windows = more reliable estimates, but slower:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Quick check</span></span>
<span><span class="va">cv_quick</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, n_windows <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Thorough evaluation</span></span>
<span><span class="va">cv_thorough</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, n_windows <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-size-step_size">Step Size (<code>step_size</code>)<a class="anchor" aria-label="anchor" href="#step-size-step_size"></a>
</h3>
<p>How far to move between folds (default: <code>h</code>):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Non-overlapping test sets (default)</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, h <span class="op">=</span> <span class="fl">6</span>, step_size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Overlapping for more windows from limited data</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, h <span class="op">=</span> <span class="fl">6</span>, step_size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="metrics">Metrics<a class="anchor" aria-label="anchor" href="#metrics"></a>
</h2>
<div class="section level3">
<h3 id="built-in-metrics">Built-in Metrics<a class="anchor" aria-label="anchor" href="#built-in-metrics"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Root Mean Squared Error (default)</span></span>
<span><span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mean Absolute Error</span></span>
<span><span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, metric <span class="op">=</span> <span class="st">"mae"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mean Absolute Percentage Error</span></span>
<span><span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, metric <span class="op">=</span> <span class="st">"mape"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mean Squared Error</span></span>
<span><span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, metric <span class="op">=</span> <span class="st">"mse"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-metrics">Custom Metrics<a class="anchor" aria-label="anchor" href="#custom-metrics"></a>
</h3>
<p>Provide a function that takes <code>(actual, predicted)</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Symmetric MAPE</span></span>
<span><span class="va">smape</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">actual</span>, <span class="va">predicted</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">actual</span> <span class="op">-</span> <span class="va">predicted</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">actual</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">predicted</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1e-8</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">smape</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="analyzing-results">Analyzing Results<a class="anchor" aria-label="anchor" href="#analyzing-results"></a>
</h2>
<div class="section level3">
<h3 id="summary-statistics">Summary Statistics<a class="anchor" aria-label="anchor" href="#summary-statistics"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cv_results</span><span class="op">)</span></span>
<span><span class="co">#&gt; Time Series Cross-Validation Summary</span></span>
<span><span class="co">#&gt; ====================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metric: rmse</span></span>
<span><span class="co">#&gt;   Mean:   54.0305</span></span>
<span><span class="co">#&gt;   Median: 54.9288</span></span>
<span><span class="co">#&gt;   SD:     9.7660</span></span>
<span><span class="co">#&gt;   Min:    43.2032</span></span>
<span><span class="co">#&gt;   Max:    64.4587</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="predictions-by-fold">Predictions by Fold<a class="anchor" aria-label="anchor" href="#predictions-by-fold"></a>
</h3>
<p>Request individual predictions for detailed analysis:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_with_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  return_predictions <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cv_with_preds</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   date       items actual predicted  fold</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2008-07-01 V10     330.      323.     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2008-08-01 V10     310.      305.     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2008-09-01 V10     326.      316.     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2008-10-01 V10     342.      358.     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2008-11-01 V10     352.      366.     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2008-12-01 V10     535.      515.     1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="per-step-accuracy">Per-Step Accuracy<a class="anchor" aria-label="anchor" href="#per-step-accuracy"></a>
</h3>
<p>Analyze how accuracy degrades with forecast horizon:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add step number within each fold</span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="va">cv_with_preds</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">fold</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>step <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate RMSE by step</span></span>
<span><span class="va">step_accuracy</span> <span class="op">&lt;-</span> <span class="va">predictions</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">step</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">actual</span> <span class="op">-</span> <span class="va">predicted</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    mae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">actual</span> <span class="op">-</span> <span class="va">predicted</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">step_accuracy</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">step_accuracy</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">step</span>, y <span class="op">=</span> <span class="va">rmse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Forecast Accuracy by Horizon"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Steps Ahead"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"RMSE"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="per-group-accuracy-panel-data">Per-Group Accuracy (Panel Data)<a class="anchor" aria-label="anchor" href="#per-group-accuracy-panel-data"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_accuracy</span> <span class="op">&lt;-</span> <span class="va">cv_with_preds</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">actual</span> <span class="op">-</span> <span class="va">predicted</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    mae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">actual</span> <span class="op">-</span> <span class="va">predicted</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Best performing groups</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">group_accuracy</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Worst performing groups</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">group_accuracy</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="model-comparison">Model Comparison<a class="anchor" aria-label="anchor" href="#model-comparison"></a>
</h2>
<p>Compare different models or feature sets:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model 1: Simple</span></span>
<span><span class="va">cv_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model 2: With seasonality</span></span>
<span><span class="va">cv_seasonal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model 3: Complex</span></span>
<span><span class="va">cv_complex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/quit.html" class="external-link">q</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rollsum</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Simple"</span>, <span class="st">"Seasonal"</span>, <span class="st">"Complex"</span><span class="op">)</span>,</span>
<span>  rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">cv_simple</span><span class="op">$</span><span class="va">metrics</span><span class="op">[</span><span class="va">cv_simple</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"rmse"</span><span class="op">]</span>,</span>
<span>    <span class="va">cv_seasonal</span><span class="op">$</span><span class="va">metrics</span><span class="op">[</span><span class="va">cv_seasonal</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"rmse"</span><span class="op">]</span>,</span>
<span>    <span class="va">cv_complex</span><span class="op">$</span><span class="va">metrics</span><span class="op">[</span><span class="va">cv_complex</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"rmse"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="comparing-different-ml-models">Comparing Different ML Models<a class="anchor" aria-label="anchor" href="#comparing-different-ml-models"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Linear model</span></span>
<span><span class="va">cv_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Random Forest</span></span>
<span><span class="va">cv_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">randomForest</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  ntree <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># XGBoost (with custom spec)</span></span>
<span><span class="va">xgb_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span>    <span class="fu">xgboost</span><span class="fu">::</span><span class="fu">xgboost</span><span class="op">(</span>data <span class="op">=</span> <span class="va">X_mat</span>, label <span class="op">=</span> <span class="va">y</span>, nrounds <span class="op">=</span> <span class="fl">100</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">X_mat</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cv_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">xgb_spec</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="model-selection-workflow">Model Selection Workflow<a class="anchor" aria-label="anchor" href="#model-selection-workflow"></a>
</h2>
<p>A recommended workflow for selecting the best model:</p>
<div class="section level3">
<h3 id="establish-baseline">1. Establish Baseline<a class="anchor" aria-label="anchor" href="#establish-baseline"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple model as baseline</span></span>
<span><span class="va">cv_baseline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">baseline_rmse</span> <span class="op">&lt;-</span> <span class="va">cv_baseline</span><span class="op">$</span><span class="va">metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Baseline RMSE:"</span>, <span class="va">baseline_rmse</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="feature-selection">2. Feature Selection<a class="anchor" aria-label="anchor" href="#feature-selection"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test adding features incrementally</span></span>
<span><span class="va">features_to_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  base <span class="op">=</span> <span class="st">"value ~ p(12)"</span>,</span>
<span>  calendar <span class="op">=</span> <span class="st">"value ~ p(12) + month()"</span>,</span>
<span>  rolling <span class="op">=</span> <span class="st">"value ~ p(12) + month() + rollsum(12)"</span>,</span>
<span>  trend <span class="op">=</span> <span class="st">"value ~ p(12) + month() + rollsum(12) + trend(1)"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">features_to_test</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">features_to_test</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>    model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>    h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    features <span class="op">=</span> <span class="va">name</span>,</span>
<span>    rmse <span class="op">=</span> <span class="va">cv</span><span class="op">$</span><span class="va">metrics</span><span class="op">[</span><span class="va">cv</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"rmse"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">feature_results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">feature_comparison</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-selection">3. Model Selection<a class="anchor" aria-label="anchor" href="#model-selection"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test different models with best features</span></span>
<span><span class="va">best_formula</span> <span class="op">&lt;-</span> <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rollsum</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">models_to_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  lm <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  rf <span class="op">=</span> <span class="va">randomForest</span>,</span>
<span>  xgb <span class="op">=</span> <span class="va">xgb_spec</span>  <span class="co"># from above</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models_to_test</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>    <span class="va">best_formula</span>,</span>
<span>    data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>    model <span class="op">=</span> <span class="va">models_to_test</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    n_windows <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">name</span>,</span>
<span>    rmse <span class="op">=</span> <span class="va">cv</span><span class="op">$</span><span class="va">metrics</span><span class="op">[</span><span class="va">cv</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"rmse"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">model_results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model_comparison</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="final-validation">4. Final Validation<a class="anchor" aria-label="anchor" href="#final-validation"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Hold out the last fold for final validation</span></span>
<span><span class="co"># Train on all but the most recent data</span></span>
<span><span class="co"># Test on most recent data only</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="panel-data-considerations">Panel Data Considerations<a class="anchor" aria-label="anchor" href="#panel-data-considerations"></a>
</h2>
<div class="section level3">
<h3 id="aligned-date-sequences">Aligned Date Sequences<a class="anchor" aria-label="anchor" href="#aligned-date-sequences"></a>
</h3>
<p><code><a href="../reference/cv_forecast.html">cv_forecast()</a></code> requires all groups to have identical date
sequences:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This will error if groups have different dates</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">unbalanced_panel</span>,  <span class="co"># Groups have different dates</span></span>
<span>  groups <span class="op">=</span> <span class="st">"store"</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Error: Cross-validation requires all groups to have identical date sequences</span></span></code></pre></div>
<p><strong>Solutions:</strong></p>
<ol style="list-style-type: decimal">
<li>Use <code><a href="../reference/TimeSeries.html">TimeSeries()</a></code> with <code>fill_time = TRUE</code> to
complete calendars</li>
<li>Filter to common date range across groups</li>
<li>Perform per-group validation separately</li>
</ol>
</div>
<div class="section level3">
<h3 id="per-group-validation">Per-Group Validation<a class="anchor" aria-label="anchor" href="#per-group-validation"></a>
</h3>
<p>For unbalanced panels, validate each group separately:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ts_data</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">items</span><span class="op">)</span></span>
<span></span>
<span><span class="va">group_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">groups</span>, <span class="kw">function</span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">group_data</span> <span class="op">&lt;-</span> <span class="va">ts_data</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">items</span> <span class="op">==</span> <span class="va">g</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span></span>
<span>      <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">group_data</span>,</span>
<span>      date <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>      model <span class="op">=</span> <span class="va">lm</span>,</span>
<span>      h <span class="op">=</span> <span class="fl">6</span>,</span>
<span>      n_windows <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cv</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      group <span class="op">=</span> <span class="va">g</span>,</span>
<span>      rmse <span class="op">=</span> <span class="va">cv</span><span class="op">$</span><span class="va">metrics</span><span class="op">[</span><span class="va">cv</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"rmse"</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">group_cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">group_cv</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="best-practices">Best Practices<a class="anchor" aria-label="anchor" href="#best-practices"></a>
</h2>
<div class="section level3">
<h3 id="match-production-horizon">1. Match Production Horizon<a class="anchor" aria-label="anchor" href="#match-production-horizon"></a>
</h3>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If you forecast 12 months ahead in production</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="co"># Not h = 1 (too optimistic) or h = 24 (different task)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="use-enough-windows">2. Use Enough Windows<a class="anchor" aria-label="anchor" href="#use-enough-windows"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># At least 5 windows for stable estimates</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, n_windows <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># More is better if you have enough data</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, n_windows <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="watch-for-data-leakage">3. Watch for Data Leakage<a class="anchor" aria-label="anchor" href="#watch-for-data-leakage"></a>
</h3>
<ul>
<li>Don’t use future information in features</li>
<li>Ensure rolling windows are backward-looking</li>
<li>Don’t tune on test data</li>
</ul>
</div>
<div class="section level3">
<h3 id="consider-computational-cost">4. Consider Computational Cost<a class="anchor" aria-label="anchor" href="#consider-computational-cost"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CV runs fit() n_windows times</span></span>
<span><span class="co"># For slow models, start with fewer windows</span></span>
<span><span class="va">cv_quick</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, n_windows <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then increase for final evaluation</span></span>
<span><span class="va">cv_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span>, n_windows <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="report-variability">5. Report Variability<a class="anchor" aria-label="anchor" href="#report-variability"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Don't just report mean RMSE</span></span>
<span><span class="co"># Show variability across folds</span></span>
<span><span class="va">fold_rmse</span> <span class="op">&lt;-</span> <span class="va">cv_results</span><span class="op">$</span><span class="va">metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fold</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean RMSE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">fold_rmse</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SD RMSE:"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">fold_rmse</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Range:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">fold_rmse</span><span class="op">)</span>, <span class="st">"-"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">fold_rmse</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="unable-to-create-cv-splits">“Unable to create CV splits”<a class="anchor" aria-label="anchor" href="#unable-to-create-cv-splits"></a>
</h3>
<p><strong>Cause</strong>: Not enough data for requested windows.</p>
<p><strong>Solution</strong>: Reduce <code>n_windows</code> or
<code>h</code>, or use more data.</p>
</div>
<div class="section level3">
<h3 id="different-results-each-run">Different Results Each Run<a class="anchor" aria-label="anchor" href="#different-results-each-run"></a>
</h3>
<p><strong>Cause</strong>: Random model (e.g., Random Forest) without
seed.</p>
<p><strong>Solution</strong>: Set seed before CV:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_forecast.html">cv_forecast</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="very-different-fold-metrics">Very Different Fold Metrics<a class="anchor" aria-label="anchor" href="#very-different-fold-metrics"></a>
</h3>
<p><strong>Cause</strong>: Non-stationarity, outliers, or regime
changes.</p>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Use sliding window for non-stationary data</li>
<li>Investigate outlier periods</li>
<li>Consider different models for different regimes</li>
</ul>
</div>
<div class="section level3">
<h3 id="high-variability-in-per-step-accuracy">High Variability in Per-Step Accuracy<a class="anchor" aria-label="anchor" href="#high-variability-in-per-step-accuracy"></a>
</h3>
<p><strong>Cause</strong>: Different difficulty at different
horizons.</p>
<p><strong>Solution</strong>: This is expected! Short-term forecasts are
usually more accurate.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<table class="table">
<thead><tr class="header">
<th>Parameter</th>
<th>Description</th>
<th>Default</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>h</code></td>
<td>Forecast horizon</td>
<td>Required</td>
</tr>
<tr class="even">
<td><code>n_windows</code></td>
<td>Number of CV folds</td>
<td>5</td>
</tr>
<tr class="odd">
<td><code>window_type</code></td>
<td>“expanding” or “sliding”</td>
<td>“expanding”</td>
</tr>
<tr class="even">
<td><code>window_size</code></td>
<td>Size for sliding window</td>
<td>NULL</td>
</tr>
<tr class="odd">
<td><code>step_size</code></td>
<td>Steps between folds</td>
<td>h</td>
</tr>
<tr class="even">
<td><code>metric</code></td>
<td>“rmse”, “mae”, “mape”, or function</td>
<td>“rmse”</td>
</tr>
<tr class="odd">
<td><code>return_predictions</code></td>
<td>Return individual predictions</td>
<td>FALSE</td>
</tr>
</tbody>
</table>
<p><strong>Key outputs:</strong></p>
<ul>
<li>
<code>$metrics</code> - Per-fold and overall metrics</li>
<li>
<code>$predictions</code> - Individual predictions (if
requested)</li>
<li>
<code>$params</code> - CV configuration</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://taf-society.org/" class="external-link">Time Series Analysis and Forecasting Society</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
