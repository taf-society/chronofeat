<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Building Custom Models • chronofeat</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Inter-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building Custom Models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chronofeat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Core Concepts</h6></li>
    <li><a class="dropdown-item" href="../articles/custom-models.html">Building Custom Models</a></li>
    <li><a class="dropdown-item" href="../articles/feature-engineering.html">Feature Engineering Reference</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing.html">Data Preprocessing</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Evaluation &amp; Production</h6></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-Validation</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-workflows.html">Advanced Workflows</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/taf-society/chronofeat" aria-label="GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Building Custom Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/taf-society/chronofeat/blob/main/vignettes/articles/custom-models.Rmd" class="external-link"><code>vignettes/articles/custom-models.Rmd</code></a></small>
      <div class="d-none name"><code>custom-models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>chronofeat is <strong>model-agnostic</strong>: it handles feature
engineering and recursive forecasting, while you provide the model. This
article shows how to integrate any machine learning framework with
chronofeat, from simple linear models to gradient boosting and neural
networks.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://taf-society.github.io/chronofeat/">chronofeat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span></span>
<span><span class="co"># Load sample data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">retail</span><span class="op">)</span></span>
<span><span class="va">ts_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TimeSeries.html">TimeSeries</a></span><span class="op">(</span><span class="va">retail</span>, date <span class="op">=</span> <span class="st">"date"</span>, groups <span class="op">=</span> <span class="st">"items"</span>, frequency <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-model-specification-interface">The Model Specification Interface<a class="anchor" aria-label="anchor" href="#the-model-specification-interface"></a>
</h2>
<p>chronofeat accepts models in two forms:</p>
<div class="section level3">
<h3 id="direct-function-simple-cases">1. Direct Function (Simple Cases)<a class="anchor" aria-label="anchor" href="#direct-function-simple-cases"></a>
</h3>
<p>For models with standard R interfaces, pass the function
directly:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Works with lm, glm, randomForest, ranger, etc.</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ts_data</span>, model <span class="op">=</span> <span class="va">lm</span><span class="op">)</span></span></code></pre></div>
<p>chronofeat internally converts this to a model specification using
<code><a href="../reference/as_model_spec.html">as_model_spec()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="model-specification-full-control">2. Model Specification (Full Control)<a class="anchor" aria-label="anchor" href="#model-specification-full-control"></a>
</h3>
<p>For complete control, provide a list with <code>fit</code> and
<code>predict</code> functions:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># y: numeric vector of target values</span></span>
<span>    <span class="co"># X: data frame of predictor columns</span></span>
<span>    <span class="co"># ...: additional arguments from fit()</span></span>
<span>    <span class="co"># Return: fitted model object</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># object: fitted model from fit()</span></span>
<span>    <span class="co"># newdata: data frame with same columns as X</span></span>
<span>    <span class="co"># Return: numeric vector of predictions</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ts_data</span>, model <span class="op">=</span> <span class="va">model_spec</span><span class="op">)</span></span></code></pre></div>
<p><strong>Key points:</strong></p>
<ul>
<li>
<code>X</code> is a <strong>data frame</strong>, not a matrix.
Factor columns remain as factors.</li>
<li>
<code>y</code> is a numeric vector (the target column)</li>
<li>Your <code>predict</code> function must return a numeric vector</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="example-1-linear-models-lm-glm">Example 1: Linear Models (lm, glm)<a class="anchor" aria-label="anchor" href="#example-1-linear-models-lm-glm"></a>
</h2>
<div class="section level3">
<h3 id="basic-linear-regression">Basic Linear Regression<a class="anchor" aria-label="anchor" href="#basic-linear-regression"></a>
</h3>
<p>The simplest approach - pass <code>lm</code> directly:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">m_lm</span>, h <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   items date       value_forecast</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> V10   2010-01-01           383.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> V10   2010-02-01           296.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> V10   2010-03-01           352.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> V10   2010-04-01           398.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> V10   2010-05-01           433.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> V10   2010-06-01           402.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="glm-for-count-data">GLM for Count Data<a class="anchor" aria-label="anchor" href="#glm-for-count-data"></a>
</h3>
<p>For count data, use a Poisson or Negative Binomial GLM:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Poisson GLM</span></span>
<span><span class="va">m_poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span> <span class="va">count</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">7</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dow</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">count_data</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  groups <span class="op">=</span> <span class="st">"store"</span>,</span>
<span>  model <span class="op">=</span> <span class="va">glm</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Negative Binomial (requires MASS)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="va">m_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">count</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">7</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dow</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">count_data</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  model <span class="op">=</span> <span class="va">glm.nb</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="regularized-regression-glmnet">Regularized Regression (glmnet)<a class="anchor" aria-label="anchor" href="#regularized-regression-glmnet"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu" class="external-link">glmnet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">glmnet_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">lambda</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># glmnet requires matrix input</span></span>
<span>    <span class="co"># Handle factors by creating model matrix</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Use cross-validation to select lambda</span></span>
<span>      <span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu">cv.glmnet</span><span class="op">(</span><span class="va">X_mat</span>, <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">alpha</span>, <span class="va">...</span><span class="op">)</span></span>
<span>      <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">cv_fit</span><span class="op">$</span><span class="va">lambda.min</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="fu">glmnet</span><span class="op">(</span><span class="va">X_mat</span>, <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">alpha</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>      lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>      formula <span class="op">=</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>  <span class="co"># Store for prediction</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, newx <span class="op">=</span> <span class="va">X_mat</span>, s <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lasso (alpha = 1)</span></span>
<span><span class="va">m_lasso</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ts_data</span>, model <span class="op">=</span> <span class="va">glmnet_spec</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ridge (alpha = 0)</span></span>
<span><span class="va">m_ridge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ts_data</span>, model <span class="op">=</span> <span class="va">glmnet_spec</span>, alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Elastic Net (alpha = 0.5)</span></span>
<span><span class="va">m_enet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ts_data</span>, model <span class="op">=</span> <span class="va">glmnet_spec</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="example-2-xgboost">Example 2: XGBoost<a class="anchor" aria-label="anchor" href="#example-2-xgboost"></a>
</h2>
<p>XGBoost is one of the most popular choices for time series
forecasting.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">xgb_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">nrounds</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Convert factors to numeric for XGBoost</span></span>
<span>    <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">X</span></span>
<span>    <span class="va">factor_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">is.factor</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">factor_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">factor_cols</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Create DMatrix</span></span>
<span>    <span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Train model</span></span>
<span>    <span class="fu">xgboost</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>      nrounds <span class="op">=</span> <span class="va">nrounds</span>,</span>
<span>      verbose <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Same factor conversion</span></span>
<span>    <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">newdata</span></span>
<span>    <span class="va">factor_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">newdata</span>, <span class="va">is.factor</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">factor_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">[</span><span class="va">factor_cols</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/quit.html" class="external-link">q</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rollsum</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">xgb_spec</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  eta <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  max_depth <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fc_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">m_xgb</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="xgboost-with-early-stopping">XGBoost with Early Stopping<a class="anchor" aria-label="anchor" href="#xgboost-with-early-stopping"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xgb_early_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">nrounds</span> <span class="op">=</span> <span class="fl">1000</span>, <span class="va">early_stopping_rounds</span> <span class="op">=</span> <span class="fl">50</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Convert factors</span></span>
<span>    <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">X</span></span>
<span>    <span class="va">factor_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">is.factor</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">factor_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">factor_cols</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Split for validation (last 20%)</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>    <span class="va">val_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">n</span><span class="op">)</span></span>
<span>    <span class="va">train_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">[</span><span class="va">train_idx</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      label <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">train_idx</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">dval</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">[</span><span class="va">val_idx</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      label <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">val_idx</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu">xgb.train</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>      watchlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>train <span class="op">=</span> <span class="va">dtrain</span>, val <span class="op">=</span> <span class="va">dval</span><span class="op">)</span>,</span>
<span>      nrounds <span class="op">=</span> <span class="va">nrounds</span>,</span>
<span>      early_stopping_rounds <span class="op">=</span> <span class="va">early_stopping_rounds</span>,</span>
<span>      verbose <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">newdata</span></span>
<span>    <span class="va">factor_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">newdata</span>, <span class="va">is.factor</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">factor_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">[</span><span class="va">factor_cols</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="example-3-lightgbm">Example 3: LightGBM<a class="anchor" aria-label="anchor" href="#example-3-lightgbm"></a>
</h2>
<p>LightGBM handles categorical features natively, making it convenient
for time series with calendar features.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Microsoft/LightGBM" class="external-link">lightgbm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">lgb_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">num_iterations</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Identify categorical columns</span></span>
<span>    <span class="va">cat_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">is.factor</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Convert factors to integer (0-indexed for LightGBM)</span></span>
<span>    <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">X</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="va">cat_cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Create dataset with categorical feature specification</span></span>
<span>    <span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">lgb.Dataset</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">)</span>,</span>
<span>      label <span class="op">=</span> <span class="va">y</span>,</span>
<span>      categorical_feature <span class="op">=</span> <span class="va">cat_cols</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu">lgb.train</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>      params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        objective <span class="op">=</span> <span class="st">"regression"</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"rmse"</span>,</span>
<span>        verbosity <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>        <span class="va">...</span></span>
<span>      <span class="op">)</span>,</span>
<span>      nrounds <span class="op">=</span> <span class="va">num_iterations</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Same factor conversion</span></span>
<span>    <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">newdata</span></span>
<span>    <span class="va">cat_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">newdata</span>, <span class="va">is.factor</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="va">cat_cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X_processed</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_lgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rollsum</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">lgb_spec</span>,</span>
<span>  num_iterations <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  learning_rate <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  num_leaves <span class="op">=</span> <span class="fl">31</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="example-4-random-forest">Example 4: Random Forest<a class="anchor" aria-label="anchor" href="#example-4-random-forest"></a>
</h2>
<div class="section level3">
<h3 id="using-randomforest">Using randomForest<a class="anchor" aria-label="anchor" href="#using-randomforest"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Direct usage (works out of the box)</span></span>
<span><span class="va">m_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">randomForest</span>,</span>
<span>  ntree <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fc_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">m_rf</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-ranger-faster">Using ranger (Faster)<a class="anchor" aria-label="anchor" href="#using-ranger-faster"></a>
</h3>
<p>ranger is a faster implementation of Random Forest:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranger_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># ranger uses formula interface</span></span>
<span>    <span class="va">train_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>.target <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, <span class="va">X</span><span class="op">)</span></span>
<span>    <span class="fu">ranger</span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_df</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_ranger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">ranger_spec</span>,</span>
<span>  num.trees <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="example-5-support-vector-machines">Example 5: Support Vector Machines<a class="anchor" aria-label="anchor" href="#example-5-support-vector-machines"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">e1071</span><span class="op">)</span></span>
<span></span>
<span><span class="va">svm_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">train_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>.target <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, <span class="va">X</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html" class="external-link">svm</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_df</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">svm_spec</span>,</span>
<span>  kernel <span class="op">=</span> <span class="st">"radial"</span>,</span>
<span>  cost <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  epsilon <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="example-6-neural-networks-kerastensorflow">Example 6: Neural Networks (Keras/TensorFlow)<a class="anchor" aria-label="anchor" href="#example-6-neural-networks-kerastensorflow"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tensorflow.rstudio.com/" class="external-link">keras</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">keras_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">epochs</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">batch_size</span> <span class="op">=</span> <span class="fl">32</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Convert all to numeric matrix</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Scale features</span></span>
<span>    <span class="va">X_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">X_mat</span><span class="op">)</span></span>
<span>    <span class="va">X_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X_mat</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>    <span class="va">X_sd</span><span class="op">[</span><span class="va">X_sd</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>  <span class="co"># Avoid division by zero</span></span>
<span>    <span class="va">X_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_mat</span>, center <span class="op">=</span> <span class="va">X_mean</span>, scale <span class="op">=</span> <span class="va">X_sd</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Scale target</span></span>
<span>    <span class="va">y_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>    <span class="va">y_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>    <span class="va">y_scaled</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">y_mean</span><span class="op">)</span> <span class="op">/</span> <span class="va">y_sd</span></span>
<span></span>
<span>    <span class="co"># Build model</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">keras_model_sequential</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">layer_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_scaled</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">layer_dropout</span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">layer_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">32</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">layer_dropout</span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">layer_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">compile</span><span class="op">(</span></span>
<span>      loss <span class="op">=</span> <span class="st">"mse"</span>,</span>
<span>      optimizer <span class="op">=</span> <span class="fu">optimizer_adam</span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Train</span></span>
<span>    <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">keras</span><span class="fu">::</span><span class="fu">fit</span><span class="op">(</span></span>
<span>      <span class="va">X_scaled</span>, <span class="va">y_scaled</span>,</span>
<span>      epochs <span class="op">=</span> <span class="va">epochs</span>,</span>
<span>      batch_size <span class="op">=</span> <span class="va">batch_size</span>,</span>
<span>      validation_split <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>      verbose <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu">callback_early_stopping</span><span class="op">(</span>patience <span class="op">=</span> <span class="fl">10</span>, restore_best_weights <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Return model with scaling parameters</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="va">model</span>,</span>
<span>      X_mean <span class="op">=</span> <span class="va">X_mean</span>,</span>
<span>      X_sd <span class="op">=</span> <span class="va">X_sd</span>,</span>
<span>      y_mean <span class="op">=</span> <span class="va">y_mean</span>,</span>
<span>      y_sd <span class="op">=</span> <span class="va">y_sd</span>,</span>
<span>      formula <span class="op">=</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span>    <span class="va">X_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_mat</span>, center <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">X_mean</span>, scale <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">X_sd</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">y_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, <span class="va">X_scaled</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">y_scaled</span> <span class="op">*</span> <span class="va">object</span><span class="op">$</span><span class="va">y_sd</span> <span class="op">+</span> <span class="va">object</span><span class="op">$</span><span class="va">y_mean</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_keras</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">keras_spec</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">64</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="example-7-ensemble-models">Example 7: Ensemble Models<a class="anchor" aria-label="anchor" href="#example-7-ensemble-models"></a>
</h2>
<p>Combine multiple models for more robust predictions:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ensemble_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Train multiple models</span></span>
<span>    <span class="va">train_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>.target <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      lm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_df</span><span class="op">)</span>,</span>
<span>      rf <span class="op">=</span> <span class="fu">randomForest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_df</span>, ntree <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Optional: train XGBoost</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">models</span><span class="op">$</span><span class="va">xgb</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu">xgboost</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">X_mat</span>, label <span class="op">=</span> <span class="va">y</span>,</span>
<span>      nrounds <span class="op">=</span> <span class="fl">100</span>, verbose <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">models</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Get predictions from each model</span></span>
<span>    <span class="va">pred_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">lm</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span>    <span class="va">pred_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">rf</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span>    <span class="va">pred_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">xgb</span>, <span class="va">X_mat</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Simple average (could use weighted average or stacking)</span></span>
<span>    <span class="op">(</span><span class="va">pred_lm</span> <span class="op">+</span> <span class="va">pred_rf</span> <span class="op">+</span> <span class="va">pred_xgb</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">value</span> <span class="op">~</span> <span class="fu">p</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu">month</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rollsum</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ts_data</span>,</span>
<span>  model <span class="op">=</span> <span class="va">ensemble_spec</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="weighted-ensemble-based-on-cv-performance">Weighted Ensemble Based on CV Performance<a class="anchor" aria-label="anchor" href="#weighted-ensemble-based-on-cv-performance"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weighted_ensemble_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">train_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>.target <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, <span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">train_df</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Train-validation split for weight estimation</span></span>
<span>    <span class="va">train_idx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>    <span class="va">val_idx</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span></span>
<span></span>
<span>    <span class="va">train_sub</span> <span class="op">&lt;-</span> <span class="va">train_df</span><span class="op">[</span><span class="va">train_idx</span>, <span class="op">]</span></span>
<span>    <span class="va">val_sub</span> <span class="op">&lt;-</span> <span class="va">train_df</span><span class="op">[</span><span class="va">val_idx</span>, <span class="op">]</span></span>
<span>    <span class="va">y_val</span> <span class="op">&lt;-</span> <span class="va">val_sub</span><span class="op">$</span><span class="va">.target</span></span>
<span></span>
<span>    <span class="co"># Train models on training subset</span></span>
<span>    <span class="va">m_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_sub</span><span class="op">)</span></span>
<span>    <span class="va">m_rf</span> <span class="op">&lt;-</span> <span class="fu">randomForest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_sub</span>, ntree <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Evaluate on validation</span></span>
<span>    <span class="va">pred_lm_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m_lm</span>, <span class="va">val_sub</span><span class="op">)</span></span>
<span>    <span class="va">pred_rf_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m_rf</span>, <span class="va">val_sub</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">rmse_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_val</span> <span class="op">-</span> <span class="va">pred_lm_val</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">rmse_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_val</span> <span class="op">-</span> <span class="va">pred_rf_val</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Inverse RMSE weighting</span></span>
<span>    <span class="va">w_lm</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">rmse_lm</span></span>
<span>    <span class="va">w_rf</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">rmse_rf</span></span>
<span>    <span class="va">w_sum</span> <span class="op">&lt;-</span> <span class="va">w_lm</span> <span class="op">+</span> <span class="va">w_rf</span></span>
<span>    <span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lm <span class="op">=</span> <span class="va">w_lm</span> <span class="op">/</span> <span class="va">w_sum</span>, rf <span class="op">=</span> <span class="va">w_rf</span> <span class="op">/</span> <span class="va">w_sum</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Retrain on full data</span></span>
<span>    <span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      lm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_df</span><span class="op">)</span>,</span>
<span>      rf <span class="op">=</span> <span class="fu">randomForest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">.target</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_df</span>, ntree <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">models</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pred_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">lm</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span>    <span class="va">pred_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">rf</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">object</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="st">"lm"</span><span class="op">]</span> <span class="op">*</span> <span class="va">pred_lm</span> <span class="op">+</span> <span class="va">object</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="st">"rf"</span><span class="op">]</span> <span class="op">*</span> <span class="va">pred_rf</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="handling-factor-variables">Handling Factor Variables<a class="anchor" aria-label="anchor" href="#handling-factor-variables"></a>
</h2>
<p>chronofeat passes factor columns as-is to your model. Different
models handle factors differently:</p>
<table class="table">
<thead><tr class="header">
<th>Model</th>
<th>Factor Handling</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>lm, glm</td>
<td>Native support (creates dummies internally)</td>
</tr>
<tr class="even">
<td>randomForest</td>
<td>Native support</td>
</tr>
<tr class="odd">
<td>ranger</td>
<td>Native support</td>
</tr>
<tr class="even">
<td>xgboost</td>
<td>Requires numeric conversion</td>
</tr>
<tr class="odd">
<td>lightgbm</td>
<td>Native categorical support</td>
</tr>
<tr class="even">
<td>glmnet</td>
<td>Requires model.matrix()</td>
</tr>
<tr class="odd">
<td>keras</td>
<td>Requires model.matrix()</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="converting-factors-for-tree-models">Converting Factors for Tree Models<a class="anchor" aria-label="anchor" href="#converting-factors-for-tree-models"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For models that need numeric input</span></span>
<span><span class="va">convert_factors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X_processed</span> <span class="op">&lt;-</span> <span class="va">X</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">is.factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">X_processed</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">X_processed</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># For models that need one-hot encoding</span></span>
<span><span class="va">one_hot_encode</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="prediction-intervals">Prediction Intervals<a class="anchor" aria-label="anchor" href="#prediction-intervals"></a>
</h2>
<p>chronofeat’s <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> returns point predictions. For
prediction intervals, implement them in your model specification:</p>
<div class="section level3">
<h3 id="quantile-regression-with-lightgbm">Quantile Regression with LightGBM<a class="anchor" aria-label="anchor" href="#quantile-regression-with-lightgbm"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lgb_quantile_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">quantiles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span><span class="op">)</span>, <span class="va">num_iterations</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">convert_factors</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">q</span> <span class="kw">in</span> <span class="va">quantiles</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">lgb.Dataset</span><span class="op">(</span>data <span class="op">=</span> <span class="va">X_mat</span>, label <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span>      <span class="va">models</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">lgb.train</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          objective <span class="op">=</span> <span class="st">"quantile"</span>,</span>
<span>          alpha <span class="op">=</span> <span class="va">q</span>,</span>
<span>          metric <span class="op">=</span> <span class="st">"quantile"</span>,</span>
<span>          verbosity <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span>        <span class="op">)</span>,</span>
<span>        nrounds <span class="op">=</span> <span class="va">num_iterations</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">models</span>, quantiles <span class="op">=</span> <span class="va">quantiles</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">convert_factors</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Return median (0.5 quantile) as point prediction</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span><span class="op">[[</span><span class="st">"0.5"</span><span class="op">]</span><span class="op">]</span>, <span class="va">X_mat</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extend forecast to get intervals</span></span>
<span><span class="va">forecast_with_intervals</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">h</span>, <span class="va">quantiles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ... custom implementation</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="bootstrap-prediction-intervals">Bootstrap Prediction Intervals<a class="anchor" aria-label="anchor" href="#bootstrap-prediction-intervals"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bootstrap_intervals</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">h</span>, <span class="va">n_boot</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">conf_level</span> <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Store original predictions</span></span>
<span>  <span class="va">fc_orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">model</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Bootstrap: resample residuals and reforecast</span></span>
<span>  <span class="co"># ... implementation depends on model type</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="model-diagnostics">Model Diagnostics<a class="anchor" aria-label="anchor" href="#model-diagnostics"></a>
</h2>
<div class="section level3">
<h3 id="checking-feature-importance">Checking Feature Importance<a class="anchor" aria-label="anchor" href="#checking-feature-importance"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For XGBoost</span></span>
<span><span class="va">importance_xgb</span> <span class="op">&lt;-</span> <span class="fu">xgb.importance</span><span class="op">(</span>model <span class="op">=</span> <span class="va">m_xgb</span><span class="op">$</span><span class="va">model_obj</span><span class="op">)</span></span>
<span><span class="fu">xgb.plot.importance</span><span class="op">(</span><span class="va">importance_xgb</span>, top_n <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For Random Forest</span></span>
<span><span class="va">importance_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/importance.html" class="external-link">importance</a></span><span class="op">(</span><span class="va">m_rf</span><span class="op">$</span><span class="va">model_obj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/varImpPlot.html" class="external-link">varImpPlot</a></span><span class="op">(</span><span class="va">m_rf</span><span class="op">$</span><span class="va">model_obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For LightGBM</span></span>
<span><span class="va">importance_lgb</span> <span class="op">&lt;-</span> <span class="fu">lgb.importance</span><span class="op">(</span><span class="va">m_lgb</span><span class="op">$</span><span class="va">model_obj</span><span class="op">)</span></span>
<span><span class="fu">lgb.plot.importance</span><span class="op">(</span><span class="va">importance_lgb</span>, top_n <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="residual-analysis">Residual Analysis<a class="anchor" aria-label="anchor" href="#residual-analysis"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get training data with predictions</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">y_actual</span> <span class="op">&lt;-</span> <span class="va">train_data</span><span class="op">[[</span><span class="va">model</span><span class="op">$</span><span class="va">spec</span><span class="op">$</span><span class="va">target</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">y_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">model_obj</span>, newdata <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>, <span class="va">model</span><span class="op">$</span><span class="va">predictors</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="va">y_actual</span> <span class="op">-</span> <span class="va">y_pred</span></span>
<span></span>
<span><span class="co"># Plot residuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y_pred</span>, <span class="va">residuals</span>, main <span class="op">=</span> <span class="st">"Residuals vs Fitted"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">residuals</span>, main <span class="op">=</span> <span class="st">"Residual Distribution"</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqline</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">acf</a></span><span class="op">(</span><span class="va">residuals</span>, main <span class="op">=</span> <span class="st">"Residual ACF"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting-common-issues">Troubleshooting Common Issues<a class="anchor" aria-label="anchor" href="#troubleshooting-common-issues"></a>
</h2>
<div class="section level3">
<h3 id="column-not-found-error">1. “Column not found” Error<a class="anchor" aria-label="anchor" href="#column-not-found-error"></a>
</h3>
<p><strong>Cause</strong>: Feature names in newdata don’t match
training.</p>
<p><strong>Solution</strong>: Check that your <code>predict</code>
function receives the same column names:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Debug: print column names</span></span>
<span><span class="va">predict</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Columns:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="co"># ...</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="na-predictions">2. NA Predictions<a class="anchor" aria-label="anchor" href="#na-predictions"></a>
</h3>
<p><strong>Cause</strong>: Model returns NA for factor levels not seen
in training, or NaN from numeric issues.</p>
<p><strong>Solution</strong>: Handle unknown levels and validate
predictions:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, <span class="va">newdata</span><span class="op">)</span></span>
<span>  <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">fallback_value</span></span>
<span>  <span class="va">pred</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="factor-level-mismatch">3. Factor Level Mismatch<a class="anchor" aria-label="anchor" href="#factor-level-mismatch"></a>
</h3>
<p><strong>Cause</strong>: New factor levels appear during forecasting
(e.g., forecasting into December when training only had Jan-Nov).</p>
<p><strong>Solution</strong>: Ensure training data covers all levels, or
handle gracefully:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># chronofeat converts unknown levels to NA automatically</span></span>
<span><span class="co"># Your model should handle NA gracefully or use numeric encoding</span></span>
<span></span>
<span><span class="co"># For tree models: convert to numeric</span></span>
<span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="memory-issues-with-large-data">4. Memory Issues with Large Data<a class="anchor" aria-label="anchor" href="#memory-issues-with-large-data"></a>
</h3>
<p><strong>Solution</strong>: Use efficient implementations:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use ranger instead of randomForest</span></span>
<span><span class="co"># Use data.table backend if available</span></span>
<span><span class="co"># Reduce number of trees/iterations for debugging</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="slow-forecasting">5. Slow Forecasting<a class="anchor" aria-label="anchor" href="#slow-forecasting"></a>
</h3>
<p><strong>Cause</strong>: Recursive forecasting calls predict() h times
per group.</p>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Use C++ accelerated path (default when no exogenous variables)</li>
<li>Simplify the model for faster predictions</li>
<li>Reduce forecast horizon</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Creating custom model specifications for chronofeat requires:</p>
<ol style="list-style-type: decimal">
<li>
<strong>A <code>fit</code> function</strong> that takes
<code>(y, X, ...)</code> and returns a model object</li>
<li>
<strong>A <code>predict</code> function</strong> that takes
<code>(object, newdata, ...)</code> and returns numeric predictions</li>
</ol>
<p>Key considerations:</p>
<ul>
<li>Handle factor columns appropriately for your model type</li>
<li>Store any preprocessing parameters (scaling, encoding) in the model
object</li>
<li>Return predictions as a numeric vector matching the input row
count</li>
<li>Test your specification on a small subset before running on full
data</li>
</ul>
<p>See the <a href="advanced-workflows.html">Advanced Workflows</a>
article for hyperparameter tuning and production deployment
patterns.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://taf-society.org/" class="external-link">Time Series Analysis and Forecasting Society</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
